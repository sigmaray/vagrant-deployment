package main

import (
	"errors"
	"log"
	"net/http"
	"os"
	"path/filepath"

	"github.com/gin-gonic/gin"
	"gorm.io/driver/sqlite"
	"gorm.io/gorm"
)

// Joke представляет модель шутки в базе данных
type Joke struct {
	ID   uint   `gorm:"primaryKey" json:"id"`
	Text string `gorm:"not null" json:"text"`
}

// Aphorism представляет модель афоризма в базе данных
type Aphorism struct {
	ID   uint   `gorm:"primaryKey" json:"id"`
	Text string `gorm:"not null" json:"text"`
}

// jokesResponse представляет структуру ответа API
type jokesResponse struct {
	Jokes     []Joke     `json:"jokes"`
	Aphorisms []Aphorism `json:"aphorisms"`
}

var db *gorm.DB

func main() {
	// Определяем путь к базе данных
	dbPath := os.Getenv("DB_PATH")
	if dbPath == "" {
		dbPath = "./data/jokes.db"
	}

	// Создаем директорию для базы данных, если её нет
	dir := filepath.Dir(dbPath)
	if dir != "." && dir != "" {
		if err := os.MkdirAll(dir, 0755); err != nil {
			log.Fatal("Не удалось создать директорию для базы данных:", err)
		}
	}

	// Инициализация базы данных
	var err error
	db, err = gorm.Open(sqlite.Open(dbPath), &gorm.Config{})
	if err != nil {
		log.Fatal("Не удалось подключиться к базе данных:", err)
	}

	// Автомиграция
	err = db.AutoMigrate(&Joke{}, &Aphorism{})
	if err != nil {
		log.Fatal("Ошибка автомиграции:", err)
	}

	// Проверка и заполнение шуток, если таблица пуста
	seedJokes()
	// Проверка и заполнение афоризмов, если таблица пуста
	seedAphorisms()

	// Настройка Gin
	r := gin.Default()

	// Endpoint для получения всех шуток
	r.GET("/", getJokes)

	// Запуск сервера
	log.Println("Сервер запущен на :8100")
	if err := r.Run(":8100"); err != nil {
		log.Fatal("Ошибка запуска сервера:", err)
	}
}

// getJokes возвращает все шутки и афоризмы из базы данных
func getJokes(c *gin.Context) {
	var jokes []Joke
	if err := db.Find(&jokes).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Ошибка получения шуток"})
		return
	}

	var aphorisms []Aphorism
	if err := db.Find(&aphorisms).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Ошибка получения афоризмов"})
		return
	}

	c.JSON(http.StatusOK, jokesResponse{Jokes: jokes, Aphorisms: aphorisms})
}

// seedJokes заполняет базу данных шутками, создавая только те, которых ещё нет
func seedJokes() {
	jokes := []Joke{
		{Text: "Почему программисты не любят природу? Там слишком много багов."},
		{Text: "Что говорит один байт другому? Мы встретимся на битовой дорожке."},
		{Text: "Почему компьютер никогда не бывает холодным? Потому что у него Windows."},
		{Text: "Как называется программист, который не пьет кофе? Сонный."},
		{Text: "Почему программисты предпочитают темный режим? Потому что свет привлекает багов."},
		{Text: "Что такое любимое блюдо программиста? Чипсы."},
		{Text: "Почему программисты не могут найти баг? Потому что он всегда в другом месте."},
		{Text: "Как программист называет своего сына? Стек."},
		{Text: "Почему программисты не любят шутки? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит ошибку? Это не баг, это фича."},
		{Text: "Почему SQL приснился программисту? Потому что он забыл WHERE."},
		{Text: "Как программист называет свою жену? Жена."},
		{Text: "Почему программисты не любят природу? Там нет Wi-Fi."},
		{Text: "Что такое любимое время программиста? Время компиляции."},
		{Text: "Почему программист всегда устал? Потому что он не спит, а дебажит."},
		{Text: "Как программист называет свою собаку? Переменная."},
		{Text: "Почему программисты не любят шутки про баги? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит красивый код? Это не мой код."},
		{Text: "Почему программист всегда прав? Потому что он использует assert."},
		{Text: "Как программист называет свою кошку? Кот."},
		{Text: "Почему программисты не любят природу? Там нет интернета."},
		{Text: "Что такое любимое место программиста? GitHub."},
		{Text: "Почему программист всегда голоден? Потому что он не ест, а компилирует."},
		{Text: "Как программист называет свою машину? Автомобиль."},
		{Text: "Почему программисты не любят шутки про код? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит ошибку? Это не ошибка, это особенность."},
		{Text: "Почему программист всегда счастлив? Потому что он использует happy path."},
		{Text: "Как программист называет свою книгу? Документация."},
		{Text: "Почему программисты не любят природу? Там нет клавиатуры."},
		{Text: "Что такое любимое животное программиста? Бит."},
		{Text: "Почему программист всегда занят? Потому что он дебажит."},
		{Text: "Как программист называет свою еду? Данные."},
		{Text: "Почему программисты не любят шутки про программирование? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит хороший код? Это не мой стиль."},
		{Text: "Почему программист всегда спокоен? Потому что он использует try-catch."},
		{Text: "Как программист называет свою музыку? Фоновая музыка."},
		{Text: "Почему программисты не любят природу? Там нет монитора."},
		{Text: "Что такое любимый цвет программиста? Зеленый (для успешных тестов)."},
		{Text: "Почему программист всегда оптимистичен? Потому что он использует оптимизацию."},
		{Text: "Как программист называет свою воду? Жидкость."},
		{Text: "Почему программисты не любят шутки про алгоритмы? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит медленный код? Это не оптимально."},
		{Text: "Почему программист всегда организован? Потому что он использует структуры данных."},
		{Text: "Как программист называет свою одежду? Интерфейс."},
		{Text: "Почему программисты не любят природу? Там нет процессора."},
		{Text: "Что такое любимое число программиста? 42."},
		{Text: "Почему программист всегда точен? Потому что он использует точные типы данных."},
		{Text: "Как программист называет свою мечту? Компиляция без ошибок."},
		{Text: "Почему программисты не любят шутки про базы данных? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит неработающий код? Это не работает."},
		{Text: "Почему программист всегда готов? Потому что он использует готовые библиотеки."},
		{Text: "Как программист называет свою жизнь? Жизненный цикл."},
		{Text: "Почему программисты не любят природу? Там нет операционной системы."},
	}

	createdCount := 0
	for _, joke := range jokes {
		var existingJoke Joke
		result := db.Where("text = ?", joke.Text).First(&existingJoke)

		// Если шутка не найдена (ошибка gorm.ErrRecordNotFound), создаём её
		if errors.Is(result.Error, gorm.ErrRecordNotFound) {
			if err := db.Create(&joke).Error; err != nil {
				log.Printf("Ошибка создания шутки: %v\n", err)
				continue
			}
			createdCount++
		} else if result.Error != nil {
			// Другая ошибка базы данных
			log.Printf("Ошибка проверки шутки: %v\n", result.Error)
		}
	}

	if createdCount > 0 {
		log.Printf("Добавлено %d новых шуток в базу данных\n", createdCount)
	}
}

// seedAphorisms заполняет базу данных афоризмами, создавая только те, которых ещё нет
func seedAphorisms() {
	aphorisms := []Aphorism{
		{Text: "Жизнь как зебра: полоса белая, полоса черная, а потом опять белая, но ты уже не помнишь, какая была первая."},
		{Text: "Если жизнь дает тебе лимоны, сделай лимонад. Если не дает лимоны, купи их в магазине."},
		{Text: "Жизнь слишком коротка, чтобы тратить её на короткие мысли."},
		{Text: "В жизни главное - не падать, а если упал, то падать красиво."},
		{Text: "Жизнь - это как велосипед: чтобы не упасть, нужно постоянно крутить педали, даже если не знаешь, куда едешь."},
		{Text: "Если ты думаешь, что жизнь несправедлива, попробуй жить справедливо - увидишь, что ничего не изменится."},
		{Text: "Жизнь - это не проблема, которую нужно решить, а реальность, которую нужно пережить."},
		{Text: "В жизни есть два типа людей: те, кто ест пиццу с ананасами, и те, кто ошибается."},
		{Text: "Жизнь похожа на кофе: горькая, но бодрящая, особенно если добавить сахар и забыть, что она горькая."},
		{Text: "Если хочешь изменить мир, начни с себя. Если не получилось, попробуй изменить другого человека."},
		{Text: "Жизнь - это как книга: некоторые главы грустные, некоторые веселые, а некоторые ты просто пропускаешь."},
		{Text: "В жизни важно не то, сколько раз ты упал, а то, сколько раз ты забыл, что уже падал."},
		{Text: "Жизнь слишком коротка, чтобы носить неудобную обувь, но достаточно длинна, чтобы жалеть об этом."},
		{Text: "Если жизнь - это игра, то я явно играю на сложном уровне, не зная правил."},
		{Text: "Жизнь - это как погода: непредсказуемая, но всегда можно пожаловаться на неё."},
		{Text: "В жизни главное - найти баланс между тем, что хочешь, и тем, что можешь себе позволить, не влезая в долги."},
		{Text: "Жизнь - это как телефон: иногда работает, иногда нет, но ты всё равно продолжаешь им пользоваться."},
		{Text: "Если ты думаешь, что жизнь сложна, попробуй объяснить её кому-то другому - станет ещё сложнее."},
		{Text: "Жизнь - это не марафон, это спринт, который длится всю жизнь."},
		{Text: "В жизни есть три вещи, которые нельзя вернуть: время, слова и потраченные деньги на ненужные вещи."},
		{Text: "Жизнь - это как шоколад: сладкая, но может быть горькой, если переборщить."},
		{Text: "Если жизнь дает тебе второй шанс, не забудь, что первый ты уже упустил."},
		{Text: "Жизнь - это как компьютер: работает, пока не сломается, а потом ты не знаешь, что делать."},
		{Text: "В жизни важно не то, что ты имеешь, а то, что ты думаешь, что имеешь, пока не потеряешь."},
		{Text: "Жизнь - это как зонтик: нужен, когда идет дождь, но ты его всегда забываешь дома."},
		{Text: "Если ты думаешь, что жизнь несправедлива, подожди - станет ещё хуже."},
		{Text: "Жизнь - это как река: течет, куда хочет, а ты просто плывешь по течению, надеясь не утонуть."},
		{Text: "В жизни главное - не сдаваться, даже если ты уже сдался несколько раз."},
		{Text: "Жизнь - это как кофе без кофеина: выглядит как кофе, но не работает как кофе."},
		{Text: "Если жизнь - это путешествие, то я явно заблудился и не знаю, где нахожусь."},
		{Text: "Жизнь - это как игра в шахматы: ты думаешь, что знаешь правила, но постоянно проигрываешь."},
		{Text: "В жизни есть два типа дней: те, когда всё идет не так, и те, когда ты просто не замечаешь, что всё идет не так."},
		{Text: "Жизнь - это как бутерброд: чем больше слоев, тем сложнее его есть, но тем вкуснее."},
		{Text: "Если ты думаешь, что жизнь сложна, попробуй жить проще - увидишь, что это тоже сложно."},
		{Text: "Жизнь - это как погода в апреле: то дождь, то солнце, то снег, а ты просто не знаешь, что надеть."},
		{Text: "В жизни важно не то, сколько у тебя друзей, а то, сколько из них помнят твой день рождения без напоминания."},
		{Text: "Жизнь - это как книга рецептов: все рецепты выглядят простыми, пока не попробуешь их приготовить."},
		{Text: "Если жизнь дает тебе лимоны, сделай лимонад. Если дает апельсины, сделай апельсиновый сок. Если ничего не дает, иди в магазин."},
		{Text: "Жизнь - это как GPS: говорит, куда ехать, но ты всё равно выбираешь свой путь и потом жалеешь."},
		{Text: "В жизни главное - не паниковать, даже если все вокруг паникуют, а ты не знаешь, почему."},
		{Text: "Жизнь - это как стиральная машина: крутит тебя, моет, сушит, а потом ты снова грязный."},
		{Text: "Если ты думаешь, что жизнь несправедлива, подожди - она станет справедливой, но не для тебя."},
		{Text: "Жизнь - это как телефонный звонок: иногда звонит, когда не нужно, а когда нужно - не звонит."},
		{Text: "В жизни есть три вещи, которые всегда возвращаются: бумеранг, плохие решения и долги."},
		{Text: "Жизнь - это как шоколадный торт: сладкая, но если съесть слишком много, станет плохо."},
		{Text: "Если жизнь - это игра, то я явно играю не по правилам, потому что не знаю правил."},
		{Text: "Жизнь - это как погода: можно жаловаться, но изменить её нельзя, только переждать."},
		{Text: "В жизни важно не то, что ты знаешь, а то, что ты думаешь, что знаешь, пока не узнаешь правду."},
		{Text: "Жизнь - это как зонтик в солнечный день: бесполезен, но ты всё равно носишь его на всякий случай."},
		{Text: "Если ты думаешь, что жизнь сложна, попробуй объяснить её себе - станет ещё сложнее."},
		{Text: "Жизнь - это как кофе: горькая, но бодрящая, особенно если добавить сахар и забыть, что она горькая."},
		{Text: "В жизни главное - не сдаваться, даже если ты уже сдался и не помнишь, зачем продолжаешь."},
		{Text: "Жизнь - это как книга: некоторые страницы интересные, некоторые скучные, а некоторые ты просто пропускаешь, чтобы быстрее закончить."},
		{Text: "Если жизнь дает тебе второй шанс, не забудь, что первый ты уже упустил, и этот тоже можешь упустить."},
	}

	createdCount := 0
	for _, aphorism := range aphorisms {
		var existingAphorism Aphorism
		result := db.Where("text = ?", aphorism.Text).First(&existingAphorism)

		// Если афоризм не найден (ошибка gorm.ErrRecordNotFound), создаём его
		if errors.Is(result.Error, gorm.ErrRecordNotFound) {
			if err := db.Create(&aphorism).Error; err != nil {
				log.Printf("Ошибка создания афоризма: %v\n", err)
				continue
			}
			createdCount++
		} else if result.Error != nil {
			// Другая ошибка базы данных
			log.Printf("Ошибка проверки афоризма: %v\n", result.Error)
		}
	}

	if createdCount > 0 {
		log.Printf("Добавлено %d новых афоризмов в базу данных\n", createdCount)
	}
}
