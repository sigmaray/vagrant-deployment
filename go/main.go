package main

import (
	"errors"
	"log"
	"net/http"

	"github.com/gin-gonic/gin"
	"gorm.io/driver/sqlite"
	"gorm.io/gorm"
)

// Joke представляет модель шутки в базе данных
type Joke struct {
	ID   uint   `gorm:"primaryKey" json:"id"`
	Text string `gorm:"not null" json:"text"`
}

// jokesResponse представляет структуру ответа API
type jokesResponse struct {
	Jokes []Joke `json:"jokes"`
}

var db *gorm.DB

func main() {
	// Инициализация базы данных
	var err error
	db, err = gorm.Open(sqlite.Open("jokes.db"), &gorm.Config{})
	if err != nil {
		log.Fatal("Не удалось подключиться к базе данных:", err)
	}

	// Автомиграция
	err = db.AutoMigrate(&Joke{})
	if err != nil {
		log.Fatal("Ошибка автомиграции:", err)
	}

	// Проверка и заполнение шуток, если таблица пуста
	seedJokes()

	// Настройка Gin
	r := gin.Default()

	// Endpoint для получения всех шуток
	r.GET("/", getJokes)

	// Запуск сервера
	log.Println("Сервер запущен на :8100")
	if err := r.Run(":8100"); err != nil {
		log.Fatal("Ошибка запуска сервера:", err)
	}
}

// getJokes возвращает все шутки из базы данных
func getJokes(c *gin.Context) {
	var jokes []Joke
	if err := db.Find(&jokes).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Ошибка получения шуток"})
		return
	}

	c.JSON(http.StatusOK, jokesResponse{Jokes: jokes})
}

// seedJokes заполняет базу данных шутками, создавая только те, которых ещё нет
func seedJokes() {
	jokes := []Joke{
		{Text: "Почему программисты не любят природу? Там слишком много багов."},
		{Text: "Что говорит один байт другому? Мы встретимся на битовой дорожке."},
		{Text: "Почему компьютер никогда не бывает холодным? Потому что у него Windows."},
		{Text: "Как называется программист, который не пьет кофе? Сонный."},
		{Text: "Почему программисты предпочитают темный режим? Потому что свет привлекает багов."},
		{Text: "Что такое любимое блюдо программиста? Чипсы."},
		{Text: "Почему программисты не могут найти баг? Потому что он всегда в другом месте."},
		{Text: "Как программист называет своего сына? Стек."},
		{Text: "Почему программисты не любят шутки? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит ошибку? Это не баг, это фича."},
		{Text: "Почему SQL приснился программисту? Потому что он забыл WHERE."},
		{Text: "Как программист называет свою жену? Жена."},
		{Text: "Почему программисты не любят природу? Там нет Wi-Fi."},
		{Text: "Что такое любимое время программиста? Время компиляции."},
		{Text: "Почему программист всегда устал? Потому что он не спит, а дебажит."},
		{Text: "Как программист называет свою собаку? Переменная."},
		{Text: "Почему программисты не любят шутки про баги? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит красивый код? Это не мой код."},
		{Text: "Почему программист всегда прав? Потому что он использует assert."},
		{Text: "Как программист называет свою кошку? Кот."},
		{Text: "Почему программисты не любят природу? Там нет интернета."},
		{Text: "Что такое любимое место программиста? GitHub."},
		{Text: "Почему программист всегда голоден? Потому что он не ест, а компилирует."},
		{Text: "Как программист называет свою машину? Автомобиль."},
		{Text: "Почему программисты не любят шутки про код? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит ошибку? Это не ошибка, это особенность."},
		{Text: "Почему программист всегда счастлив? Потому что он использует happy path."},
		{Text: "Как программист называет свою книгу? Документация."},
		{Text: "Почему программисты не любят природу? Там нет клавиатуры."},
		{Text: "Что такое любимое животное программиста? Бит."},
		{Text: "Почему программист всегда занят? Потому что он дебажит."},
		{Text: "Как программист называет свою еду? Данные."},
		{Text: "Почему программисты не любят шутки про программирование? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит хороший код? Это не мой стиль."},
		{Text: "Почему программист всегда спокоен? Потому что он использует try-catch."},
		{Text: "Как программист называет свою музыку? Фоновая музыка."},
		{Text: "Почему программисты не любят природу? Там нет монитора."},
		{Text: "Что такое любимый цвет программиста? Зеленый (для успешных тестов)."},
		{Text: "Почему программист всегда оптимистичен? Потому что он использует оптимизацию."},
		{Text: "Как программист называет свою воду? Жидкость."},
		{Text: "Почему программисты не любят шутки про алгоритмы? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит медленный код? Это не оптимально."},
		{Text: "Почему программист всегда организован? Потому что он использует структуры данных."},
		{Text: "Как программист называет свою одежду? Интерфейс."},
		{Text: "Почему программисты не любят природу? Там нет процессора."},
		{Text: "Что такое любимое число программиста? 42."},
		{Text: "Почему программист всегда точен? Потому что он использует точные типы данных."},
		{Text: "Как программист называет свою мечту? Компиляция без ошибок."},
		{Text: "Почему программисты не любят шутки про базы данных? Потому что они не смешные."},
		{Text: "Что говорит программист, когда видит неработающий код? Это не работает."},
		{Text: "Почему программист всегда готов? Потому что он использует готовые библиотеки."},
		{Text: "Как программист называет свою жизнь? Жизненный цикл."},
		{Text: "Почему программисты не любят природу? Там нет операционной системы."},
	}

	createdCount := 0
	for _, joke := range jokes {
		var existingJoke Joke
		result := db.Where("text = ?", joke.Text).First(&existingJoke)

		// Если шутка не найдена (ошибка gorm.ErrRecordNotFound), создаём её
		if errors.Is(result.Error, gorm.ErrRecordNotFound) {
			if err := db.Create(&joke).Error; err != nil {
				log.Printf("Ошибка создания шутки: %v\n", err)
				continue
			}
			createdCount++
		} else if result.Error != nil {
			// Другая ошибка базы данных
			log.Printf("Ошибка проверки шутки: %v\n", result.Error)
		}
	}

	if createdCount > 0 {
		log.Printf("Добавлено %d новых шуток в базу данных\n", createdCount)
	}
}
